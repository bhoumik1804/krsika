# Rice Mill SaaS Platform - Backend Implementation Plan

> **Project**: Rice Mill Management System
> **Version**: 1.0.0
> **Created**: January 28, 2026
> **Tech Stack**: Node.js + Express + JavaScript + MongoDB + Socket.io

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [Technology Stack](#2-technology-stack)
3. [Project Structure](#3-project-structure)
4. [Database Design](#4-database-design)
5. [Authentication & Authorization](#5-authentication--authorization)
6. [API Modules](#6-api-modules)
7. [Real-Time Communication](#7-real-time-communication)
8. [Security Implementation](#8-security-implementation)
9. [Error Handling](#9-error-handling)
10. [Logging & Monitoring](#10-logging--monitoring)
11. [Testing Strategy](#11-testing-strategy)
12. [Deployment & DevOps](#12-deployment--devops)
13. [Implementation Phases](#13-implementation-phases)

---

## 1. Architecture Overview

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
│                     (React + TypeScript + Vite)                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/REST + WebSocket
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API GATEWAY                                     │
│                    (Express + Rate Limiting + CORS)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            ▼                       ▼                       ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│   AUTH SERVICE    │   │   CORE SERVICE    │   │  SOCKET SERVICE   │
│   (Passport.js)   │   │   (Business)      │   │   (Socket.io)     │
└───────────────────┘   └───────────────────┘   └───────────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DATA ACCESS LAYER                                  │
│                      (Mongoose ODM + MongoDB)                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────┐
                        │     MongoDB       │
                        │   (Primary DB)    │
                        └───────────────────┘
```

### Microservices-Ready Modular Monolith

The architecture follows a **modular monolith** pattern that can easily evolve into microservices:

- **Bounded Contexts**: Each module is self-contained
- **Shared Kernel**: Common utilities and infrastructure
- **Event-Driven**: Internal event bus for module communication
- **API Versioning**: Support for multiple API versions

---

## 2. Technology Stack

### Core Technologies

| Category       | Technology        | Purpose                 |
| -------------- | ----------------- | ----------------------- |
| Runtime        | Node.js (Latest)  | Server runtime          |
| Language       | JavaScript (ES6+) | Development language    |
| Framework      | Express.js 4.x    | HTTP server             |
| ODM            | Mongoose 8.x      | MongoDB object modeling |
| Database       | MongoDB 7.x       | Primary database        |
| Authentication | Passport.js       | Auth strategies         |
| Real-time      | Socket.io 4.x     | WebSocket communication |
| Validation     | Zod               | Schema validation       |

### Development Tools

| Tool            | Purpose            |
| --------------- | ------------------ |
| ESLint          | Code linting       |
| Prettier        | Code formatting    |
| Jest            | Unit testing       |
| Supertest       | API testing        |
| Docker          | Containerization   |
| Husky           | Git hooks          |
| Swagger/OpenAPI | API documentation  |
| Nodemon         | Development server |

### Security Packages

| Package                | Purpose                       |
| ---------------------- | ----------------------------- |
| helmet                 | HTTP security headers         |
| cors                   | Cross-origin resource sharing |
| express-rate-limit     | Rate limiting                 |
| bcrypt                 | Password hashing              |
| jsonwebtoken           | JWT handling                  |
| express-mongo-sanitize | NoSQL injection prevention    |

---

## 3. Project Structure

```
server/
├── src/
│   ├── app.js                          # Express app setup
│   ├── server.js                       # Server entry point
│   │
│   ├── config/                         # Configuration
│   │   ├── index.js                    # Config aggregator
│   │   ├── database.js                 # MongoDB config
│   │   ├── auth.js                     # Auth config (JWT secrets)
│   │   ├── socket.js                   # Socket.io config
│   │   └── env.js                      # Environment variables
│   │
│   ├── modules/                        # Feature modules (Bounded Contexts)
│   │   │
│   │   ├── auth/                       # Authentication Module
│   │   │   ├── controllers/
│   │   │   │   └── auth.controller.js
│   │   │   ├── services/
│   │   │   │   ├── auth.service.js
│   │   │   │   └── token.service.js
│   │   │   ├── strategies/
│   │   │   │   ├── jwt.strategy.js
│   │   │   │   ├── local.strategy.js
│   │   │   │   ├── google.strategy.js
│   │   │   │   └── github.strategy.js
│   │   │   ├── middlewares/
│   │   │   │   ├── authenticate.js
│   │   │   │   └── authorize.js
│   │   │   ├── validators/
│   │   │   │   └── auth.validator.js
│   │   │   ├── routes/
│   │   │   │   └── auth.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── user/                       # User Management Module
│   │   │   ├── controllers/
│   │   │   │   └── user.controller.js
│   │   │   ├── services/
│   │   │   │   └── user.service.js
│   │   │   ├── validators/
│   │   │   │   └── user.validator.js
│   │   │   ├── routes/
│   │   │   │   └── user.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── mill/                       # Mill Management Module
│   │   │   ├── controllers/
│   │   │   │   ├── mill.controller.js
│   │   │   │   └── mill-settings.controller.js
│   │   │   ├── services/
│   │   │   │   ├── mill.service.js
│   │   │   │   └── mill-dashboard.service.js
│   │   │   ├── validators/
│   │   │   │   └── mill.validator.js
│   │   │   ├── routes/
│   │   │   │   └── mill.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── staff/                      # Staff Management Module
│   │   │   ├── controllers/
│   │   │   │   ├── staff.controller.js
│   │   │   │   └── attendance.controller.js
│   │   │   ├── services/
│   │   │   │   ├── staff.service.js
│   │   │   │   └── attendance.service.js
│   │   │   ├── routes/
│   │   │   │   └── staff.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── purchase/                   # Purchase Module
│   │   │   ├── controllers/
│   │   │   │   ├── paddy-purchase.controller.js
│   │   │   │   ├── rice-purchase.controller.js
│   │   │   │   ├── gunny-purchase.controller.js
│   │   │   │   ├── frk-purchase.controller.js
│   │   │   │   └── other-purchase.controller.js
│   │   │   ├── services/
│   │   │   │   ├── purchase.service.js
│   │   │   │   └── purchase-report.service.js
│   │   │   ├── routes/
│   │   │   │   └── purchase.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── sales/                      # Sales Module
│   │   │   ├── controllers/
│   │   │   │   ├── rice-sale.controller.js
│   │   │   │   ├── paddy-sale.controller.js
│   │   │   │   ├── gunny-sale.controller.js
│   │   │   │   ├── khanda-sale.controller.js
│   │   │   │   ├── nakkhi-sale.controller.js
│   │   │   │   └── other-sale.controller.js
│   │   │   ├── services/
│   │   │   │   ├── sale.service.js
│   │   │   │   └── sale-report.service.js
│   │   │   ├── routes/
│   │   │   │   └── sales.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── inventory/                  # Inventory/Stock Module
│   │   │   ├── controllers/
│   │   │   │   ├── stock.controller.js
│   │   │   │   └── inventory.controller.js
│   │   │   ├── services/
│   │   │   │   ├── stock.service.js
│   │   │   │   ├── stock-alert.service.js
│   │   │   │   └── inventory.service.js
│   │   │   ├── routes/
│   │   │   │   └── inventory.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── inward/                     # Inward Module
│   │   │   ├── controllers/
│   │   │   │   ├── govt-paddy-inward.controller.js
│   │   │   │   ├── private-paddy-inward.controller.js
│   │   │   │   ├── rice-inward.controller.js
│   │   │   │   ├── gunny-inward.controller.js
│   │   │   │   ├── frk-inward.controller.js
│   │   │   │   └── other-inward.controller.js
│   │   │   ├── services/
│   │   │   │   └── inward.service.js
│   │   │   ├── routes/
│   │   │   │   └── inward.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── outward/                    # Outward Module
│   │   │   ├── controllers/
│   │   │   │   ├── govt-rice-outward.controller.js
│   │   │   │   ├── private-rice-outward.controller.js
│   │   │   │   ├── paddy-outward.controller.js
│   │   │   │   ├── gunny-outward.controller.js
│   │   │   │   ├── frk-outward.controller.js
│   │   │   │   ├── khanda-outward.controller.js
│   │   │   │   ├── nakkhi-outward.controller.js
│   │   │   │   ├── bhusa-outward.controller.js
│   │   │   │   ├── kodha-outward.controller.js
│   │   │   │   └── other-outward.controller.js
│   │   │   ├── services/
│   │   │   │   └── outward.service.js
│   │   │   ├── routes/
│   │   │   │   └── outward.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── milling/                    # Milling/Processing Module
│   │   │   ├── controllers/
│   │   │   │   ├── paddy-milling.controller.js
│   │   │   │   └── rice-milling.controller.js
│   │   │   ├── services/
│   │   │   │   ├── milling.service.js
│   │   │   │   └── conversion.service.js
│   │   │   ├── routes/
│   │   │   │   └── milling.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── financial/                  # Financial Module
│   │   │   ├── controllers/
│   │   │   │   ├── receipt.controller.js
│   │   │   │   └── payment.controller.js
│   │   │   ├── services/
│   │   │   │   ├── receipt.service.js
│   │   │   │   ├── payment.service.js
│   │   │   │   └── ledger.service.js
│   │   │   ├── routes/
│   │   │   │   └── financial.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── labour/                     # Labour Cost Module
│   │   │   ├── controllers/
│   │   │   │   └── labour.controller.js
│   │   │   ├── services/
│   │   │   │   └── labour.service.js
│   │   │   ├── routes/
│   │   │   │   └── labour.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── balance-lifting/            # Balance Lifting Module
│   │   │   ├── controllers/
│   │   │   │   └── balance-lifting.controller.js
│   │   │   ├── services/
│   │   │   │   └── balance-lifting.service.js
│   │   │   ├── routes/
│   │   │   │   └── balance-lifting.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── reports/                    # Reports Module
│   │   │   ├── controllers/
│   │   │   │   ├── daily-report.controller.js
│   │   │   │   ├── transaction-report.controller.js
│   │   │   │   └── export.controller.js
│   │   │   ├── services/
│   │   │   │   ├── daily-report.service.js
│   │   │   │   ├── broker-transaction.service.js
│   │   │   │   ├── party-transaction.service.js
│   │   │   │   └── export.service.js
│   │   │   ├── routes/
│   │   │   │   └── reports.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── masters/                    # Master Data Module
│   │   │   ├── controllers/
│   │   │   │   ├── party.controller.js
│   │   │   │   ├── broker.controller.js
│   │   │   │   ├── transporter.controller.js
│   │   │   │   ├── committee.controller.js
│   │   │   │   ├── vehicle.controller.js
│   │   │   │   ├── do.controller.js
│   │   │   │   └── labour-group.controller.js
│   │   │   ├── services/
│   │   │   │   └── master.service.js
│   │   │   ├── routes/
│   │   │   │   └── masters.routes.js
│   │   │   └── index.js
│   │   │
│   │   ├── subscription/               # Subscription Module
│   │   │   ├── controllers/
│   │   │   │   └── subscription.controller.js
│   │   │   ├── services/
│   │   │   │   ├── subscription.service.js
│   │   │   │   └── billing.service.js
│   │   │   ├── routes/
│   │   │   │   └── subscription.routes.js
│   │   │   └── index.js
│   │   │
│   │   └── notification/               # Notification Module
│   │       ├── controllers/
│   │       │   └── notification.controller.js
│   │       ├── services/
│   │       │   ├── notification.service.js
│   │       │   ├── email.service.js
│   │       │   └── sms.service.js
│   │       ├── templates/
│   │       │   └── ...
│   │       ├── routes/
│   │       │   └── notification.routes.js
│   │       └── index.js
│   │
│   ├── shared/                         # Shared Infrastructure
│   │   ├── database/
│   │   │   ├── connection.js           # MongoDB connection
│   │   │   └── seed.js                 # Database seeding
│   │   │
│   │   ├── models/                     # Mongoose Models
│   │   │   ├── user.model.js
│   │   │   ├── refresh-token.model.js
│   │   │   ├── mill.model.js
│   │   │   ├── staff.model.js
│   │   │   ├── attendance.model.js
│   │   │   ├── purchase.model.js
│   │   │   ├── sale.model.js
│   │   │   ├── inward.model.js
│   │   │   ├── outward.model.js
│   │   │   ├── milling.model.js
│   │   │   ├── receipt.model.js
│   │   │   ├── payment.model.js
│   │   │   ├── stock.model.js
│   │   │   ├── party.model.js
│   │   │   ├── broker.model.js
│   │   │   ├── transporter.model.js
│   │   │   ├── committee.model.js
│   │   │   ├── vehicle.model.js
│   │   │   ├── delivery-order.model.js
│   │   │   ├── labour-group.model.js
│   │   │   ├── labour-cost.model.js
│   │   │   ├── subscription.model.js
│   │   │   └── audit-log.model.js
│   │   │
│   │   ├── socket/
│   │   │   ├── index.js
│   │   │   ├── handlers/
│   │   │   │   ├── connection.handler.js
│   │   │   │   ├── notification.handler.js
│   │   │   │   └── activity.handler.js
│   │   │   └── namespaces/
│   │   │       ├── admin.namespace.js
│   │   │       ├── mill.namespace.js
│   │   │       └── dashboard.namespace.js
│   │   │
│   │   ├── middlewares/
│   │   │   ├── error-handler.js
│   │   │   ├── not-found.js
│   │   │   ├── request-logger.js
│   │   │   ├── rate-limiter.js
│   │   │   ├── validate-request.js
│   │   │   ├── cors.js
│   │   │   └── security.js
│   │   │
│   │   ├── utils/
│   │   │   ├── api-response.js
│   │   │   ├── api-error.js
│   │   │   ├── async-handler.js
│   │   │   ├── pagination.js
│   │   │   ├── date.js
│   │   │   ├── string.js
│   │   │   └── calculation.js
│   │   │
│   │   ├── constants/
│   │   │   ├── index.js
│   │   │   ├── roles.js
│   │   │   ├── permissions.js
│   │   │   ├── stock-types.js
│   │   │   ├── payment-types.js
│   │   │   └── error-codes.js
│   │   │
│   │   └── events/
│   │       ├── event-emitter.js
│   │       └── event-types.js
│   │
│   └── routes/
│       └── v1/
│           └── index.js                # API v1 route aggregator
│
├── tests/
│   ├── unit/
│   │   └── ...
│   ├── integration/
│   │   └── ...
│   └── e2e/
│       └── ...
│
├── scripts/
│   └── seed.js
│
├── docs/
│   ├── api/
│   │   └── openapi.yaml
│   └── postman/
│       └── collection.json
│
├── .env
├── .env.example
├── .eslintrc.js
├── .prettierrc
├── .gitignore
├── docker-compose.yml
├── Dockerfile
├── package.json
└── README.md
```

---

## 4. Database Design

### Entity Relationship Diagram

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│      User       │────<│   RefreshToken  │     │  Subscription   │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ _id             │     │ _id             │     │ _id             │
│ email           │     │ token           │     │ millId          │
│ password        │     │ userId          │     │ plan            │
│ name            │     │ expiresAt       │     │ status          │
│ avatar          │     │ createdAt       │     │ startDate       │
│ role            │     │ deviceInfo      │     │ endDate         │
│ isActive        │     └─────────────────┘     │ amount          │
│ isEmailVerified │                             └─────────────────┘
│ millId          │                                     │
└─────────────────┘                                     │
        │                                               │
        │                                               │
        ▼                                               ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│      Mill       │────<│     Staff       │────<│   Attendance    │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ _id             │     │ _id             │     │ _id             │
│ name            │     │ millId          │     │ staffId         │
│ code            │     │ userId          │     │ date            │
│ address         │     │ name            │     │ checkIn         │
│ city            │     │ phone           │     │ checkOut        │
│ state           │     │ role            │     │ status          │
│ pincode         │     │ salary          │     │ notes           │
│ phone           │     │ joiningDate     │     └─────────────────┘
│ email           │     │ isActive        │
│ gstNumber       │     └─────────────────┘
│ status          │
│ ownerId         │
└─────────────────┘
        │
        │ (1:N relationships to all mill-specific entities)
        │
        ├──────────────────────────────────────────────────────────┐
        │              │              │              │              │
        ▼              ▼              ▼              ▼              ▼
┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐
│  Purchase  │  │    Sale    │  │   Inward   │  │  Outward   │  │  Milling   │
├────────────┤  ├────────────┤  ├────────────┤  ├────────────┤  ├────────────┤
│ ...        │  │ ...        │  │ ...        │  │ ...        │  │ ...        │
└────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘
        │              │              │              │              │
        └──────────────┴──────────────┴──────────────┴──────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Master Data                                     │
├────────────┬────────────┬─────────────┬────────────┬──────────┬─────────────┤
│   Party    │   Broker   │ Transporter │ Committee  │ Vehicle  │ LabourGroup │
└────────────┴────────────┴─────────────┴────────────┴──────────┴─────────────┘
```

### Mongoose Schemas

```javascript
// src/shared/models/user.model.js
const mongoose = require("mongoose");
const bcrypt = require("bcrypt");

const UserRole = {
  SUPER_ADMIN: "SUPER_ADMIN",
  MILL_ADMIN: "MILL_ADMIN",
  MILL_STAFF: "MILL_STAFF",
};

const userSchema = new mongoose.Schema(
  {
    email: {
      type: String,
      required: true,
      unique: true,
      lowercase: true,
      trim: true,
    },
    password: {
      type: String,
      required: true,
      select: false,
    },
    name: {
      type: String,
      required: true,
      trim: true,
    },
    avatar: String,
    phone: String,
    role: {
      type: String,
      enum: Object.values(UserRole),
      default: UserRole.MILL_STAFF,
    },
    isActive: {
      type: Boolean,
      default: true,
    },
    isEmailVerified: {
      type: Boolean,
      default: false,
    },
    lastLoginAt: Date,
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
    },
  },
  {
    timestamps: true,
  },
);

// Index for faster queries
userSchema.index({ email: 1 });
userSchema.index({ millId: 1 });

// Hash password before saving
userSchema.pre("save", async function (next) {
  if (!this.isModified("password")) return next();
  this.password = await bcrypt.hash(this.password, 12);
  next();
});

// Compare password method
userSchema.methods.comparePassword = async function (candidatePassword) {
  return bcrypt.compare(candidatePassword, this.password);
};

module.exports = mongoose.model("User", userSchema);
module.exports.UserRole = UserRole;
```

```javascript
// src/shared/models/refresh-token.model.js
const mongoose = require("mongoose");

const refreshTokenSchema = new mongoose.Schema(
  {
    token: {
      type: String,
      required: true,
      unique: true,
    },
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
    deviceInfo: String,
    ipAddress: String,
    expiresAt: {
      type: Date,
      required: true,
    },
    isRevoked: {
      type: Boolean,
      default: false,
    },
  },
  {
    timestamps: true,
  },
);

// Index for faster queries
refreshTokenSchema.index({ token: 1 });
refreshTokenSchema.index({ userId: 1 });
refreshTokenSchema.index({ expiresAt: 1 }, { expireAfterSeconds: 0 }); // TTL index

module.exports = mongoose.model("RefreshToken", refreshTokenSchema);
```

```javascript
// src/shared/models/mill.model.js
const mongoose = require("mongoose");

const MillStatus = {
  ACTIVE: "ACTIVE",
  INACTIVE: "INACTIVE",
  SUSPENDED: "SUSPENDED",
  PENDING: "PENDING",
};

const millSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
      trim: true,
    },
    code: {
      type: String,
      required: true,
      unique: true,
      uppercase: true,
    },
    address: {
      type: String,
      required: true,
    },
    city: {
      type: String,
      required: true,
    },
    state: {
      type: String,
      required: true,
    },
    pincode: {
      type: String,
      required: true,
    },
    phone: {
      type: String,
      required: true,
    },
    email: String,
    gstNumber: String,
    panNumber: String,
    status: {
      type: String,
      enum: Object.values(MillStatus),
      default: MillStatus.PENDING,
    },
    logo: String,
    ownerId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
  },
  {
    timestamps: true,
  },
);

millSchema.index({ code: 1 });
millSchema.index({ ownerId: 1 });

module.exports = mongoose.model("Mill", millSchema);
module.exports.MillStatus = MillStatus;
```

```javascript
// src/shared/models/staff.model.js
const mongoose = require("mongoose");

const StaffRole = {
  MANAGER: "MANAGER",
  ACCOUNTANT: "ACCOUNTANT",
  SUPERVISOR: "SUPERVISOR",
  OPERATOR: "OPERATOR",
  LABOURER: "LABOURER",
  SECURITY: "SECURITY",
  OTHER: "OTHER",
};

const staffSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
    name: {
      type: String,
      required: true,
    },
    phone: {
      type: String,
      required: true,
    },
    email: String,
    role: {
      type: String,
      enum: Object.values(StaffRole),
      required: true,
    },
    salary: {
      type: Number,
      required: true,
    },
    joiningDate: {
      type: Date,
      required: true,
    },
    address: String,
    aadharNumber: String,
    isActive: {
      type: Boolean,
      default: true,
    },
  },
  {
    timestamps: true,
  },
);

staffSchema.index({ millId: 1 });

module.exports = mongoose.model("Staff", staffSchema);
module.exports.StaffRole = StaffRole;
```

```javascript
// src/shared/models/attendance.model.js
const mongoose = require("mongoose");

const AttendanceStatus = {
  PRESENT: "PRESENT",
  ABSENT: "ABSENT",
  HALF_DAY: "HALF_DAY",
  LEAVE: "LEAVE",
};

const attendanceSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    staffId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Staff",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    checkIn: Date,
    checkOut: Date,
    status: {
      type: String,
      enum: Object.values(AttendanceStatus),
      default: AttendanceStatus.PRESENT,
    },
    notes: String,
  },
  {
    timestamps: true,
  },
);

attendanceSchema.index({ millId: 1, staffId: 1, date: 1 }, { unique: true });

module.exports = mongoose.model("Attendance", attendanceSchema);
module.exports.AttendanceStatus = AttendanceStatus;
```

```javascript
// src/shared/models/party.model.js
const mongoose = require("mongoose");

const partySchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    name: {
      type: String,
      required: true,
    },
    gstn: String,
    phone: String,
    email: String,
    address: String,
    city: String,
    state: String,
    pincode: String,
    bankName: String,
    accountNumber: String,
    ifscCode: String,
    openingBalance: {
      type: Number,
      default: 0,
    },
    currentBalance: {
      type: Number,
      default: 0,
    },
    isActive: {
      type: Boolean,
      default: true,
    },
  },
  {
    timestamps: true,
  },
);

partySchema.index({ millId: 1 });
partySchema.index({ millId: 1, name: 1 });

module.exports = mongoose.model("Party", partySchema);
```

```javascript
// src/shared/models/broker.model.js
const mongoose = require("mongoose");

const brokerSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    name: {
      type: String,
      required: true,
    },
    phone: String,
    email: String,
    address: String,
    commissionRate: {
      type: Number,
      default: 0,
    },
    openingBalance: {
      type: Number,
      default: 0,
    },
    currentBalance: {
      type: Number,
      default: 0,
    },
    isActive: {
      type: Boolean,
      default: true,
    },
  },
  {
    timestamps: true,
  },
);

brokerSchema.index({ millId: 1 });

module.exports = mongoose.model("Broker", brokerSchema);
```

```javascript
// src/shared/models/purchase.model.js
const mongoose = require("mongoose");

const StockType = {
  PADDY_MOTA: "PADDY_MOTA",
  PADDY_PATLA: "PADDY_PATLA",
  PADDY_SARNA: "PADDY_SARNA",
  PADDY_MAHAMAYA: "PADDY_MAHAMAYA",
  PADDY_RB_GOLD: "PADDY_RB_GOLD",
  RICE_MOTA: "RICE_MOTA",
  RICE_PATLA: "RICE_PATLA",
  GUNNY_NEW: "GUNNY_NEW",
  GUNNY_OLD: "GUNNY_OLD",
  GUNNY_PLASTIC: "GUNNY_PLASTIC",
  FRK: "FRK",
  KHANDA: "KHANDA",
  NAKKHI: "NAKKHI",
  BHUSA: "BHUSA",
  KODHA: "KODHA",
  SILKY_KODHA: "SILKY_KODHA",
  OTHER: "OTHER",
};

const DeliveryType = {
  PADE_MEIN: "PADE_MEIN",
  PAHUNCHA_KAR: "PAHUNCHA_KAR",
};

const PurchaseType = {
  DO_KHARIDI: "DO_KHARIDI",
  OTHER_KHARIDI: "OTHER_KHARIDI",
  LOT_KHARIDI: "LOT_KHARIDI",
};

const PaymentStatus = {
  PENDING: "PENDING",
  PARTIAL: "PARTIAL",
  PAID: "PAID",
};

const purchaseSchema = new mongoose.Schema(
  {
    purchaseNumber: {
      type: String,
      required: true,
      unique: true,
    },
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    partyId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Party",
    },
    brokerId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Broker",
    },
    deliveryType: {
      type: String,
      enum: Object.values(DeliveryType),
    },
    purchaseType: {
      type: String,
      enum: Object.values(PurchaseType),
    },
    deliveryOrderId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "DeliveryOrder",
    },
    doQuantity: Number,
    stockType: {
      type: String,
      enum: Object.values(StockType),
      required: true,
    },
    stockCategory: {
      type: String,
      required: true,
    },
    quantity: {
      type: Number,
      required: true,
    },
    unit: {
      type: String,
      default: "quintal",
    },
    ratePerUnit: {
      type: Number,
      required: true,
    },
    discountPercent: Number,
    brokeragePerUnit: Number,
    // Gunny Details
    gunnyType: String,
    gunnyNewQty: Number,
    gunnyOldQty: Number,
    gunnyPlasticQty: Number,
    gunnyNewRate: Number,
    gunnyOldRate: Number,
    gunnyPlasticRate: Number,
    // Totals
    grossAmount: {
      type: Number,
      required: true,
    },
    discountAmount: {
      type: Number,
      default: 0,
    },
    netAmount: {
      type: Number,
      required: true,
    },
    paidAmount: {
      type: Number,
      default: 0,
    },
    balanceAmount: {
      type: Number,
      required: true,
    },
    paymentStatus: {
      type: String,
      enum: Object.values(PaymentStatus),
      default: PaymentStatus.PENDING,
    },
    remarks: String,
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

purchaseSchema.index({ millId: 1 });
purchaseSchema.index({ date: 1 });
purchaseSchema.index({ partyId: 1 });
purchaseSchema.index({ stockCategory: 1 });

module.exports = mongoose.model("Purchase", purchaseSchema);
module.exports.StockType = StockType;
module.exports.DeliveryType = DeliveryType;
module.exports.PurchaseType = PurchaseType;
module.exports.PaymentStatus = PaymentStatus;
```

```javascript
// src/shared/models/sale.model.js
const mongoose = require("mongoose");
const { StockType, PaymentStatus } = require("./purchase.model");

const saleSchema = new mongoose.Schema(
  {
    saleNumber: {
      type: String,
      required: true,
      unique: true,
    },
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    partyId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Party",
    },
    brokerId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Broker",
    },
    stockType: {
      type: String,
      enum: Object.values(StockType),
      required: true,
    },
    stockCategory: {
      type: String,
      required: true,
    },
    quantity: {
      type: Number,
      required: true,
    },
    unit: {
      type: String,
      default: "quintal",
    },
    ratePerUnit: {
      type: Number,
      required: true,
    },
    discountPercent: Number,
    brokeragePerUnit: Number,
    // Gunny Details
    gunnyNewQty: Number,
    gunnyOldQty: Number,
    gunnyPlasticQty: Number,
    gunnyNewRate: Number,
    gunnyOldRate: Number,
    gunnyPlasticRate: Number,
    // Totals
    grossAmount: {
      type: Number,
      required: true,
    },
    discountAmount: {
      type: Number,
      default: 0,
    },
    netAmount: {
      type: Number,
      required: true,
    },
    receivedAmount: {
      type: Number,
      default: 0,
    },
    balanceAmount: {
      type: Number,
      required: true,
    },
    paymentStatus: {
      type: String,
      enum: Object.values(PaymentStatus),
      default: PaymentStatus.PENDING,
    },
    remarks: String,
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

saleSchema.index({ millId: 1 });
saleSchema.index({ date: 1 });
saleSchema.index({ partyId: 1 });

module.exports = mongoose.model("Sale", saleSchema);
```

```javascript
// src/shared/models/stock.model.js
const mongoose = require("mongoose");
const { StockType } = require("./purchase.model");

const stockSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    stockType: {
      type: String,
      enum: Object.values(StockType),
      required: true,
    },
    quantity: {
      type: Number,
      required: true,
      default: 0,
    },
    unit: {
      type: String,
      default: "quintal",
    },
    avgRate: Number,
    totalValue: Number,
    warehouseLocation: String,
    minStockLevel: {
      type: Number,
      default: 0,
    },
  },
  {
    timestamps: true,
  },
);

stockSchema.index({ millId: 1, stockType: 1 }, { unique: true });

module.exports = mongoose.model("Stock", stockSchema);
```

```javascript
// src/shared/models/milling.model.js
const mongoose = require("mongoose");
const { StockType } = require("./purchase.model");

const MillingType = {
  PADDY_TO_RICE: "PADDY_TO_RICE",
  RICE_SORTING: "RICE_SORTING",
};

const millingSchema = new mongoose.Schema(
  {
    millingNumber: {
      type: String,
      required: true,
      unique: true,
    },
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    millingType: {
      type: String,
      enum: Object.values(MillingType),
      required: true,
    },
    // Input
    inputStockType: {
      type: String,
      enum: Object.values(StockType),
      required: true,
    },
    inputQuantity: {
      type: Number,
      required: true,
    },
    // Outputs
    outputs: [
      {
        stockType: {
          type: String,
          enum: Object.values(StockType),
        },
        quantity: Number,
        rate: Number,
      },
    ],
    // By-products
    khandaQty: Number,
    nakkhiQty: Number,
    bhusaQty: Number,
    kodhaQty: Number,
    // Conversion ratio
    conversionRatio: Number,
    wastagePercent: Number,
    remarks: String,
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

millingSchema.index({ millId: 1 });
millingSchema.index({ date: 1 });

module.exports = mongoose.model("Milling", millingSchema);
module.exports.MillingType = MillingType;
```

```javascript
// src/shared/models/receipt.model.js
const mongoose = require("mongoose");

const ReceiptMode = {
  CASH: "CASH",
  CHEQUE: "CHEQUE",
  BANK_TRANSFER: "BANK_TRANSFER",
  UPI: "UPI",
};

const receiptSchema = new mongoose.Schema(
  {
    receiptNumber: {
      type: String,
      required: true,
      unique: true,
    },
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    partyId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Party",
      required: true,
    },
    amount: {
      type: Number,
      required: true,
    },
    mode: {
      type: String,
      enum: Object.values(ReceiptMode),
      required: true,
    },
    referenceNumber: String,
    chequeNumber: String,
    chequeDate: Date,
    bankName: String,
    remarks: String,
    // Link to sale
    saleId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Sale",
    },
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

receiptSchema.index({ millId: 1 });
receiptSchema.index({ partyId: 1 });
receiptSchema.index({ date: 1 });

module.exports = mongoose.model("Receipt", receiptSchema);
module.exports.ReceiptMode = ReceiptMode;
```

```javascript
// src/shared/models/payment.model.js
const mongoose = require("mongoose");
const { ReceiptMode } = require("./receipt.model");

const paymentSchema = new mongoose.Schema(
  {
    paymentNumber: {
      type: String,
      required: true,
      unique: true,
    },
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    partyId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Party",
      required: true,
    },
    amount: {
      type: Number,
      required: true,
    },
    mode: {
      type: String,
      enum: Object.values(ReceiptMode),
      required: true,
    },
    referenceNumber: String,
    chequeNumber: String,
    chequeDate: Date,
    bankName: String,
    remarks: String,
    // Link to purchase
    purchaseId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Purchase",
    },
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

paymentSchema.index({ millId: 1 });
paymentSchema.index({ partyId: 1 });
paymentSchema.index({ date: 1 });

module.exports = mongoose.model("Payment", paymentSchema);
```

```javascript
// src/shared/models/delivery-order.model.js
const mongoose = require("mongoose");

const DOStatus = {
  ACTIVE: "ACTIVE",
  PARTIAL: "PARTIAL",
  COMPLETED: "COMPLETED",
  CANCELLED: "CANCELLED",
};

const deliveryOrderSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    doNumber: {
      type: String,
      required: true,
    },
    committeeId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Committee",
    },
    year: {
      type: String,
      required: true,
    },
    totalQuantity: {
      type: Number,
      required: true,
    },
    receivedQuantity: {
      type: Number,
      default: 0,
    },
    balanceQuantity: {
      type: Number,
      required: true,
    },
    status: {
      type: String,
      enum: Object.values(DOStatus),
      default: DOStatus.ACTIVE,
    },
    remarks: String,
  },
  {
    timestamps: true,
  },
);

deliveryOrderSchema.index({ millId: 1 });
deliveryOrderSchema.index({ doNumber: 1 });

module.exports = mongoose.model("DeliveryOrder", deliveryOrderSchema);
module.exports.DOStatus = DOStatus;
```

```javascript
// src/shared/models/labour-cost.model.js
const mongoose = require("mongoose");

const LabourType = {
  INWARD: "INWARD",
  OUTWARD: "OUTWARD",
  MILLING: "MILLING",
  OTHER: "OTHER",
};

const labourCostSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
    },
    date: {
      type: Date,
      required: true,
    },
    labourType: {
      type: String,
      enum: Object.values(LabourType),
      required: true,
    },
    labourGroupId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "LabourGroup",
    },
    description: String,
    quantity: Number,
    ratePerUnit: Number,
    totalAmount: {
      type: Number,
      required: true,
    },
    paidAmount: {
      type: Number,
      default: 0,
    },
    remarks: String,
    createdById: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  },
);

labourCostSchema.index({ millId: 1 });
labourCostSchema.index({ date: 1 });

module.exports = mongoose.model("LabourCost", labourCostSchema);
module.exports.LabourType = LabourType;
```

```javascript
// src/shared/models/subscription.model.js
const mongoose = require("mongoose");

const SubscriptionPlan = {
  FREE: "FREE",
  BASIC: "BASIC",
  PROFESSIONAL: "PROFESSIONAL",
  ENTERPRISE: "ENTERPRISE",
};

const SubscriptionStatus = {
  ACTIVE: "ACTIVE",
  EXPIRED: "EXPIRED",
  CANCELLED: "CANCELLED",
  TRIAL: "TRIAL",
};

const subscriptionSchema = new mongoose.Schema(
  {
    millId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Mill",
      required: true,
      unique: true,
    },
    plan: {
      type: String,
      enum: Object.values(SubscriptionPlan),
      default: SubscriptionPlan.FREE,
    },
    status: {
      type: String,
      enum: Object.values(SubscriptionStatus),
      default: SubscriptionStatus.TRIAL,
    },
    startDate: {
      type: Date,
      required: true,
    },
    endDate: {
      type: Date,
      required: true,
    },
    amount: Number,
    paymentId: String,
    features: {
      maxUsers: {
        type: Number,
        default: 2,
      },
      maxTransactions: Number,
      reportsEnabled: {
        type: Boolean,
        default: false,
      },
      exportEnabled: {
        type: Boolean,
        default: false,
      },
    },
  },
  {
    timestamps: true,
  },
);

subscriptionSchema.index({ millId: 1 });
subscriptionSchema.index({ status: 1, endDate: 1 });

module.exports = mongoose.model("Subscription", subscriptionSchema);
module.exports.SubscriptionPlan = SubscriptionPlan;
module.exports.SubscriptionStatus = SubscriptionStatus;
```

---

## 5. Authentication & Authorization

### 5.1 Passport.js Configuration

```javascript
// src/modules/auth/strategies/jwt.strategy.js
const { Strategy: JwtStrategy, ExtractJwt } = require("passport-jwt");
const config = require("../../../config");
const User = require("../../../shared/models/user.model");

// Access Token Strategy
const accessTokenStrategy = new JwtStrategy(
  {
    jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
    secretOrKey: config.auth.accessTokenSecret,
    algorithms: ["HS256"],
  },
  async (payload, done) => {
    try {
      const user = await User.findById(payload.sub).populate("millId").lean();

      if (!user || !user.isActive) {
        return done(null, false);
      }

      return done(null, user);
    } catch (error) {
      return done(error, false);
    }
  },
);

// Refresh Token Strategy (separate secret)
const refreshTokenStrategy = new JwtStrategy(
  {
    jwtFromRequest: ExtractJwt.fromBodyField("refreshToken"),
    secretOrKey: config.auth.refreshTokenSecret,
    algorithms: ["HS256"],
    passReqToCallback: true,
  },
  async (req, payload, done) => {
    try {
      const RefreshToken = require("../../../shared/models/refresh-token.model");
      const refreshToken = req.body.refreshToken;

      const storedToken = await RefreshToken.findOne({ token: refreshToken })
        .populate("userId")
        .lean();

      if (!storedToken || storedToken.isRevoked) {
        return done(null, false);
      }

      if (new Date() > storedToken.expiresAt) {
        return done(null, false);
      }

      return done(null, storedToken.userId);
    } catch (error) {
      return done(error, false);
    }
  },
);

module.exports = {
  accessTokenStrategy,
  refreshTokenStrategy,
};
```

```javascript
// src/modules/auth/strategies/local.strategy.js
const { Strategy: LocalStrategy } = require("passport-local");
const User = require("../../../shared/models/user.model");

const localStrategy = new LocalStrategy(
  {
    usernameField: "email",
    passwordField: "password",
  },
  async (email, password, done) => {
    try {
      const user = await User.findOne({ email: email.toLowerCase() })
        .select("+password")
        .lean();

      if (!user) {
        return done(null, false, { message: "Invalid email or password" });
      }

      if (!user.isActive) {
        return done(null, false, { message: "Account is deactivated" });
      }

      const bcrypt = require("bcrypt");
      const isMatch = await bcrypt.compare(password, user.password);

      if (!isMatch) {
        return done(null, false, { message: "Invalid email or password" });
      }

      // Remove password from user object
      delete user.password;
      return done(null, user);
    } catch (error) {
      return done(error, false);
    }
  },
);

module.exports = { localStrategy };
```

### 5.2 Token Service

```javascript
// src/modules/auth/services/token.service.js
const jwt = require("jsonwebtoken");
const crypto = require("crypto");
const config = require("../../../config");
const RefreshToken = require("../../../shared/models/refresh-token.model");

class TokenService {
  // ACCESS TOKEN - Short lived (15 minutes)
  generateAccessToken(user) {
    const payload = {
      sub: user._id.toString(),
      email: user.email,
      role: user.role,
      millId: user.millId ? user.millId.toString() : undefined,
    };

    return jwt.sign(payload, config.auth.accessTokenSecret, {
      expiresIn: config.auth.accessTokenExpiresIn, // '15m'
      algorithm: "HS256",
      issuer: "rice-mill-api",
      audience: "rice-mill-client",
    });
  }

  // REFRESH TOKEN - Long lived (7 days)
  async generateRefreshToken(user, deviceInfo, ipAddress) {
    const token = crypto.randomBytes(64).toString("hex");
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 7); // 7 days

    await RefreshToken.create({
      token,
      userId: user._id,
      deviceInfo,
      ipAddress,
      expiresAt,
    });

    return token;
  }

  // Verify and decode access token
  verifyAccessToken(token) {
    try {
      return jwt.verify(token, config.auth.accessTokenSecret, {
        algorithms: ["HS256"],
        issuer: "rice-mill-api",
        audience: "rice-mill-client",
      });
    } catch {
      return null;
    }
  }

  // Revoke refresh token
  async revokeRefreshToken(token) {
    await RefreshToken.updateOne({ token }, { isRevoked: true });
  }

  // Revoke all user tokens (logout from all devices)
  async revokeAllUserTokens(userId) {
    await RefreshToken.updateMany(
      { userId, isRevoked: false },
      { isRevoked: true },
    );
  }

  // Cleanup expired tokens (run via cron)
  async cleanupExpiredTokens() {
    const result = await RefreshToken.deleteMany({
      $or: [{ expiresAt: { $lt: new Date() } }, { isRevoked: true }],
    });
    return result.deletedCount;
  }
}

module.exports = new TokenService();
```

### 5.3 Auth Service

```javascript
// src/modules/auth/services/auth.service.js
const User = require("../../../shared/models/user.model");
const tokenService = require("./token.service");
const {
  UnauthorizedError,
  ConflictError,
  BadRequestError,
} = require("../../../shared/utils/api-error");

class AuthService {
  async signIn(email, password, deviceInfo, ipAddress) {
    const user = await User.findOne({ email: email.toLowerCase() })
      .select("+password")
      .populate("millId");

    if (!user) {
      throw new UnauthorizedError("Invalid email or password");
    }

    if (!user.isActive) {
      throw new UnauthorizedError("Account is deactivated");
    }

    const isMatch = await user.comparePassword(password);

    if (!isMatch) {
      throw new UnauthorizedError("Invalid email or password");
    }

    // Update last login
    await User.findByIdAndUpdate(user._id, { lastLoginAt: new Date() });

    // Generate tokens
    const accessToken = tokenService.generateAccessToken(user);
    const refreshToken = await tokenService.generateRefreshToken(
      user,
      deviceInfo,
      ipAddress,
    );

    // Remove password from response
    const userResponse = user.toObject();
    delete userResponse.password;

    return {
      user: userResponse,
      accessToken,
      refreshToken,
      expiresIn: 900, // 15 minutes in seconds
    };
  }

  async signUp(userData) {
    const existingUser = await User.findOne({
      email: userData.email.toLowerCase(),
    });

    if (existingUser) {
      throw new ConflictError("Email already registered");
    }

    const user = await User.create({
      ...userData,
      email: userData.email.toLowerCase(),
    });

    return user;
  }

  async refreshToken(refreshToken, deviceInfo, ipAddress) {
    const RefreshToken = require("../../../shared/models/refresh-token.model");

    const storedToken = await RefreshToken.findOne({
      token: refreshToken,
    }).populate("userId");

    if (!storedToken || storedToken.isRevoked) {
      throw new UnauthorizedError("Invalid refresh token");
    }

    if (new Date() > storedToken.expiresAt) {
      throw new UnauthorizedError("Refresh token expired");
    }

    const user = storedToken.userId;

    if (!user || !user.isActive) {
      throw new UnauthorizedError("User not found or inactive");
    }

    // Revoke old token (token rotation)
    await tokenService.revokeRefreshToken(refreshToken);

    // Generate new tokens
    const newAccessToken = tokenService.generateAccessToken(user);
    const newRefreshToken = await tokenService.generateRefreshToken(
      user,
      deviceInfo,
      ipAddress,
    );

    return {
      accessToken: newAccessToken,
      refreshToken: newRefreshToken,
      expiresIn: 900,
    };
  }

  async logout(refreshToken) {
    await tokenService.revokeRefreshToken(refreshToken);
  }

  async logoutAll(userId) {
    await tokenService.revokeAllUserTokens(userId);
  }
}

module.exports = new AuthService();
```

### 5.4 Auth Controller

```javascript
// src/modules/auth/controllers/auth.controller.js
const authService = require("../services/auth.service");
const asyncHandler = require("../../../shared/utils/async-handler");
const ApiResponse = require("../../../shared/utils/api-response");

class AuthController {
  signIn = asyncHandler(async (req, res) => {
    const { email, password } = req.body;
    const deviceInfo = req.headers["user-agent"];
    const ipAddress = req.ip;

    const result = await authService.signIn(
      email,
      password,
      deviceInfo,
      ipAddress,
    );

    res.json(ApiResponse.success(result, "Login successful"));
  });

  signUp = asyncHandler(async (req, res) => {
    const user = await authService.signUp(req.body);

    res
      .status(201)
      .json(
        ApiResponse.created(
          { user },
          "Registration successful. Please verify your email.",
        ),
      );
  });

  refreshToken = asyncHandler(async (req, res) => {
    const { refreshToken } = req.body;
    const deviceInfo = req.headers["user-agent"];
    const ipAddress = req.ip;

    const result = await authService.refreshToken(
      refreshToken,
      deviceInfo,
      ipAddress,
    );

    res.json(ApiResponse.success(result, "Token refreshed"));
  });

  logout = asyncHandler(async (req, res) => {
    const { refreshToken } = req.body;

    await authService.logout(refreshToken);

    res.json(ApiResponse.success(null, "Logged out successfully"));
  });

  logoutAll = asyncHandler(async (req, res) => {
    await authService.logoutAll(req.user._id);

    res.json(ApiResponse.success(null, "Logged out from all devices"));
  });

  me = asyncHandler(async (req, res) => {
    res.json(ApiResponse.success(req.user));
  });
}

module.exports = new AuthController();
```

### 5.5 Auth Routes

```javascript
// src/modules/auth/routes/auth.routes.js
const { Router } = require("express");
const passport = require("passport");
const authController = require("../controllers/auth.controller");
const {
  validate,
  signInSchema,
  signUpSchema,
  refreshTokenSchema,
} = require("../validators/auth.validator");

const router = Router();

// Public routes
router.post("/sign-in", validate(signInSchema), authController.signIn);
router.post("/sign-up", validate(signUpSchema), authController.signUp);
router.post(
  "/refresh-token",
  validate(refreshTokenSchema),
  authController.refreshToken,
);

// Protected routes
router.use(passport.authenticate("jwt-access", { session: false }));

router.post("/logout", authController.logout);
router.post("/logout-all", authController.logoutAll);
router.get("/me", authController.me);

module.exports = router;
```

### 5.6 Role-Based Authorization Middleware

```javascript
// src/modules/auth/middlewares/authorize.js
const { ForbiddenError } = require("../../../shared/utils/api-error");

const PERMISSIONS = {
  // Super Admin Only
  "admin:mills:manage": { roles: ["SUPER_ADMIN"] },
  "admin:users:manage": { roles: ["SUPER_ADMIN"] },
  "admin:subscriptions:manage": { roles: ["SUPER_ADMIN"] },

  // Mill Admin
  "mill:staff:manage": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:financial:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:financial:write": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:milling:manage": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:inward:manage": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:outward:manage": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:stock:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },
  "mill:balance-lifting:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN"],
    millAccess: "own",
  },

  // Mill Staff
  "mill:purchase:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:purchase:write": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:sale:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:sale:write": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:masters:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:masters:write": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
  "mill:dashboard:read": {
    roles: ["SUPER_ADMIN", "MILL_ADMIN", "MILL_STAFF"],
    millAccess: "own",
  },
};

const authorize = (...permissions) => {
  return (req, res, next) => {
    const user = req.user;

    if (!user) {
      throw new ForbiddenError("Access denied");
    }

    // Super admin has all permissions
    if (user.role === "SUPER_ADMIN") {
      return next();
    }

    for (const permission of permissions) {
      const config = PERMISSIONS[permission];

      if (!config) {
        continue;
      }

      // Check role
      if (!config.roles.includes(user.role)) {
        throw new ForbiddenError("Insufficient permissions");
      }

      // Check mill access
      if (config.millAccess === "own") {
        const millId = req.params.millId || req.body.millId;
        const userMillId = user.millId ? user.millId.toString() : null;
        if (millId && userMillId !== millId) {
          throw new ForbiddenError("Access denied to this mill");
        }
      }
    }

    next();
  };
};

module.exports = { authorize, PERMISSIONS };
```

### 5.7 Auth Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SIGN IN FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────┘

Client                          Server                         Database
  │                               │                               │
  │  POST /auth/sign-in           │                               │
  │  {email, password}            │                               │
  │──────────────────────────────>│                               │
  │                               │  Validate credentials         │
  │                               │──────────────────────────────>│
  │                               │                               │
  │                               │  Generate Access Token        │
  │                               │  (15 min, ACCESS_SECRET)      │
  │                               │                               │
  │                               │  Generate Refresh Token       │
  │                               │  (7 days, REFRESH_SECRET)     │
  │                               │──────────────────────────────>│
  │                               │  Store in refresh_tokens      │
  │                               │                               │
  │  {accessToken, refreshToken,  │                               │
  │   user, expiresIn}            │                               │
  │<──────────────────────────────│                               │
  │                               │                               │

┌─────────────────────────────────────────────────────────────────────────────┐
│                           TOKEN REFRESH FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

Client                          Server                         Database
  │                               │                               │
  │  POST /auth/refresh-token     │                               │
  │  {refreshToken}               │                               │
  │──────────────────────────────>│                               │
  │                               │  Verify refresh token         │
  │                               │──────────────────────────────>│
  │                               │  Check not revoked/expired    │
  │                               │                               │
  │                               │  Revoke old refresh token     │
  │                               │──────────────────────────────>│
  │                               │                               │
  │                               │  Generate NEW tokens          │
  │                               │  (Token Rotation)             │
  │                               │──────────────────────────────>│
  │                               │  Store new refresh token      │
  │                               │                               │
  │  {accessToken, refreshToken,  │                               │
  │   expiresIn}                  │                               │
  │<──────────────────────────────│                               │
  │                               │                               │
```

---

## 6. API Modules

### 6.1 API Endpoints Summary

#### Authentication (`/api/v1/auth`)

| Method | Endpoint           | Description               |
| ------ | ------------------ | ------------------------- |
| POST   | `/sign-in`         | User login                |
| POST   | `/sign-up`         | User registration         |
| POST   | `/refresh-token`   | Refresh access token      |
| POST   | `/logout`          | Logout (revoke tokens)    |
| POST   | `/logout-all`      | Logout from all devices   |
| POST   | `/forgot-password` | Request password reset    |
| POST   | `/reset-password`  | Reset password with token |
| POST   | `/verify-otp`      | Verify OTP code           |
| GET    | `/google`          | Google OAuth login        |
| GET    | `/google/callback` | Google OAuth callback     |
| GET    | `/github`          | GitHub OAuth login        |
| GET    | `/github/callback` | GitHub OAuth callback     |
| GET    | `/me`              | Get current user          |

#### Super Admin (`/api/v1/admin`)

| Method | Endpoint             | Description              |
| ------ | -------------------- | ------------------------ |
| GET    | `/dashboard`         | Platform dashboard stats |
| GET    | `/mills`             | List all mills           |
| POST   | `/mills`             | Create new mill          |
| GET    | `/mills/:id`         | Get mill details         |
| PUT    | `/mills/:id`         | Update mill              |
| DELETE | `/mills/:id`         | Delete mill              |
| GET    | `/users`             | List all users           |
| POST   | `/users`             | Create user              |
| PUT    | `/users/:id`         | Update user              |
| DELETE | `/users/:id`         | Delete user              |
| GET    | `/subscriptions`     | List subscriptions       |
| PUT    | `/subscriptions/:id` | Update subscription      |

#### Mill Operations (`/api/v1/mills/:millId`)

| Category        | Endpoints                                                                                                     |
| --------------- | ------------------------------------------------------------------------------------------------------------- |
| Dashboard       | `GET /dashboard`                                                                                              |
| Staff           | `GET/POST /staff`, `GET/PUT/DELETE /staff/:id`, `GET/POST /staff/:id/attendance`                              |
| Purchases       | `GET/POST /purchases/paddy`, `/rice`, `/gunny`, `/frk`, `/other`                                              |
| Sales           | `GET/POST /sales/rice`, `/paddy`, `/gunny`, `/khanda`, `/nakkhi`, `/other`                                    |
| Inward          | `GET/POST /inward/govt-paddy`, `/private-paddy`, `/rice`, `/gunny`, `/frk`, `/other`                          |
| Outward         | `GET/POST /outward/govt-rice`, `/private-rice`, `/paddy`, `/gunny`, `/frk`, etc.                              |
| Milling         | `GET/POST /milling/paddy`, `/rice`                                                                            |
| Financial       | `GET/POST /financial/receipts`, `/payments`                                                                   |
| Stock           | `GET /stock/overview`, `/paddy`, `/rice`, `/by-products`, `/gunny`                                            |
| Labour          | `GET/POST /labour/inward`, `/outward`, `/milling`, `/other`                                                   |
| Balance Lifting | `GET /balance-lifting/purchases/*`, `/sales/*`, `/outward-rice`                                               |
| Reports         | `GET /reports/daily/*`, `/transactions/broker`, `/transactions/party`                                         |
| Masters         | `GET/POST /masters/parties`, `/brokers`, `/transporters`, `/committees`, `/vehicles`, `/do`, `/labour-groups` |

### 6.2 Sample Controller Implementation

```javascript
// src/modules/purchase/controllers/paddy-purchase.controller.js
const PaddyPurchaseService = require("../services/paddy-purchase.service");
const asyncHandler = require("../../../shared/utils/async-handler");
const ApiResponse = require("../../../shared/utils/api-response");
const { NotFoundError } = require("../../../shared/utils/api-error");

class PaddyPurchaseController {
  getAll = asyncHandler(async (req, res) => {
    const { millId } = req.params;
    const { page, limit, sortBy, sortOrder, ...filters } = req.query;

    const result = await PaddyPurchaseService.findAll(millId, {
      page: Number(page) || 1,
      limit: Number(limit) || 10,
      sortBy,
      sortOrder,
      filters,
    });

    res.json(ApiResponse.paginated(result.data, result.pagination));
  });

  getById = asyncHandler(async (req, res) => {
    const { millId, id } = req.params;

    const purchase = await PaddyPurchaseService.findById(millId, id);

    if (!purchase) {
      throw new NotFoundError("Purchase not found");
    }

    res.json(ApiResponse.success(purchase));
  });

  create = asyncHandler(async (req, res) => {
    const { millId } = req.params;
    const dto = req.body;

    const purchase = await PaddyPurchaseService.create(
      millId,
      dto,
      req.user._id,
    );

    // Emit real-time event
    req.app.get("io").to(`mill:${millId}`).emit("purchase:created", purchase);

    res.status(201).json(ApiResponse.created(purchase));
  });

  update = asyncHandler(async (req, res) => {
    const { millId, id } = req.params;
    const dto = req.body;

    const purchase = await PaddyPurchaseService.update(millId, id, dto);

    req.app.get("io").to(`mill:${millId}`).emit("purchase:updated", purchase);

    res.json(ApiResponse.success(purchase, "Purchase updated successfully"));
  });

  delete = asyncHandler(async (req, res) => {
    const { millId, id } = req.params;

    await PaddyPurchaseService.delete(millId, id);

    req.app.get("io").to(`mill:${millId}`).emit("purchase:deleted", { id });

    res.json(ApiResponse.success(null, "Purchase deleted successfully"));
  });
}

module.exports = new PaddyPurchaseController();
```

---

## 7. Real-Time Communication

### 7.1 Socket.io Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SOCKET.IO ARCHITECTURE                             │
└─────────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────────────┐
                        │    Socket Server    │
                        │    (Socket.io)      │
                        └─────────────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │                     │                     │
            ▼                     ▼                     ▼
   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
   │    /admin       │   │    /mill        │   │   /dashboard    │
   │   namespace     │   │   namespace     │   │   namespace     │
   └─────────────────┘   └─────────────────┘   └─────────────────┘
            │                     │                     │
            │              ┌──────┴──────┐              │
            │              │             │              │
            ▼              ▼             ▼              ▼
   ┌────────────┐   ┌────────────┐ ┌────────────┐ ┌────────────┐
   │ super-admin │   │ mill:123  │ │ mill:456  │ │ dashboard  │
   │   room     │   │   room    │ │   room    │ │   room     │
   └────────────┘   └────────────┘ └────────────┘ └────────────┘
```

### 7.2 Socket.io Implementation

```javascript
// src/shared/socket/index.js
const { Server } = require("socket.io");
const tokenService = require("../../modules/auth/services/token.service");
const User = require("../models/user.model");

function initializeSocket(httpServer) {
  const io = new Server(httpServer, {
    cors: {
      origin: process.env.CLIENT_URL,
      credentials: true,
    },
    pingTimeout: 60000,
    pingInterval: 25000,
  });

  // Authentication middleware
  io.use(async (socket, next) => {
    try {
      const token = socket.handshake.auth.token;

      if (!token) {
        return next(new Error("Authentication required"));
      }

      const payload = tokenService.verifyAccessToken(token);

      if (!payload) {
        return next(new Error("Invalid token"));
      }

      const user = await User.findById(payload.sub)
        .select("_id role millId name")
        .lean();

      if (!user) {
        return next(new Error("User not found"));
      }

      socket.data.user = user;
      next();
    } catch (error) {
      next(new Error("Authentication failed"));
    }
  });

  io.on("connection", (socket) => {
    const user = socket.data.user;
    console.log(`User connected: ${user._id}`);

    // Join user-specific room
    socket.join(`user:${user._id}`);

    // Join role-based rooms
    if (user.role === "SUPER_ADMIN") {
      socket.join("admin");
    }

    // Join mill room
    if (user.millId) {
      socket.join(`mill:${user.millId}`);
    }

    // Handle events
    setupEventHandlers(socket, io);

    // Disconnect handler
    socket.on("disconnect", () => {
      console.log(`User disconnected: ${user._id}`);
    });
  });

  return io;
}

function setupEventHandlers(socket, io) {
  const user = socket.data.user;

  // Join specific mill room (for super admin viewing mills)
  socket.on("join:mill", (millId) => {
    if (user.role === "SUPER_ADMIN" || user.millId?.toString() === millId) {
      socket.join(`mill:${millId}`);
    }
  });

  // Leave mill room
  socket.on("leave:mill", (millId) => {
    socket.leave(`mill:${millId}`);
  });

  // Activity typing indicator
  socket.on("activity:typing", (data) => {
    socket.to(`mill:${data.millId}`).emit("activity:typing", {
      user: { id: user._id, name: user.name },
      entity: data.entity,
    });
  });
}

module.exports = { initializeSocket };
```

### 7.3 Real-Time Events

```javascript
// src/shared/socket/events.js

// Events emitted by server
const SERVER_EVENTS = {
  // Notifications
  NOTIFICATION: "notification",

  // Purchase events
  PURCHASE_CREATED: "purchase:created",
  PURCHASE_UPDATED: "purchase:updated",
  PURCHASE_DELETED: "purchase:deleted",

  // Sale events
  SALE_CREATED: "sale:created",
  SALE_UPDATED: "sale:updated",
  SALE_DELETED: "sale:deleted",

  // Inward/Outward events
  INWARD_CREATED: "inward:created",
  OUTWARD_CREATED: "outward:created",

  // Milling events
  MILLING_STARTED: "milling:started",
  MILLING_COMPLETED: "milling:completed",

  // Stock events
  STOCK_UPDATED: "stock:updated",
  STOCK_LOW_ALERT: "stock:low-alert",

  // Financial events
  PAYMENT_RECEIVED: "payment:received",
  PAYMENT_MADE: "payment:made",

  // Dashboard updates
  DASHBOARD_STATS: "dashboard:stats",

  // Activity feed
  ACTIVITY_NEW: "activity:new",

  // Staff events
  ATTENDANCE_MARKED: "attendance:marked",
};

// Events listened by server
const CLIENT_EVENTS = {
  JOIN_MILL: "join:mill",
  LEAVE_MILL: "leave:mill",
  ACTIVITY_TYPING: "activity:typing",
  REQUEST_DASHBOARD: "request:dashboard",
};

module.exports = { SERVER_EVENTS, CLIENT_EVENTS };
```

---

## 8. Security Implementation

### 8.1 Security Middleware Stack

```javascript
// src/shared/middlewares/security.js
const helmet = require("helmet");
const cors = require("cors");
const rateLimit = require("express-rate-limit");
const mongoSanitize = require("express-mongo-sanitize");
const config = require("../../config");

function setupSecurity(app) {
  // Helmet - Set security HTTP headers
  app.use(
    helmet({
      contentSecurityPolicy: {
        directives: {
          defaultSrc: ["'self'"],
          styleSrc: ["'self'", "'unsafe-inline'"],
          scriptSrc: ["'self'"],
          imgSrc: ["'self'", "data:", "https:"],
        },
      },
      crossOriginEmbedderPolicy: false,
    }),
  );

  // CORS
  app.use(
    cors({
      origin: config.cors.origin,
      credentials: true,
      methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
      allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With"],
    }),
  );

  // Rate limiting - General
  const generalLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // 100 requests per window
    message: { error: "Too many requests, please try again later" },
    standardHeaders: true,
    legacyHeaders: false,
  });
  app.use("/api", generalLimiter);

  // Rate limiting - Auth endpoints (stricter)
  const authLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 10, // 10 attempts per 15 minutes
    message: { error: "Too many authentication attempts" },
  });
  app.use("/api/v1/auth", authLimiter);

  // Prevent NoSQL injection
  app.use(mongoSanitize());

  // Disable X-Powered-By header
  app.disable("x-powered-by");
}

module.exports = { setupSecurity };
```

### 8.2 Input Validation with Zod

```javascript
// src/modules/auth/validators/auth.validator.js
const { z } = require("zod");

const signInSchema = z.object({
  body: z.object({
    email: z.string().email("Invalid email format"),
    password: z.string().min(8, "Password must be at least 8 characters"),
  }),
});

const signUpSchema = z.object({
  body: z.object({
    name: z.string().min(2, "Name must be at least 2 characters"),
    email: z.string().email("Invalid email format"),
    password: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,
        "Password must contain uppercase, lowercase, number and special character",
      ),
    phone: z
      .string()
      .regex(/^[6-9]\d{9}$/, "Invalid Indian phone number")
      .optional(),
  }),
});

const refreshTokenSchema = z.object({
  body: z.object({
    refreshToken: z.string().min(1, "Refresh token is required"),
  }),
});

// Validation middleware
const validate = (schema) => {
  return (req, res, next) => {
    try {
      schema.parse({
        body: req.body,
        query: req.query,
        params: req.params,
      });
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        const errors = error.errors.map((e) => ({
          field: e.path.join("."),
          message: e.message,
        }));
        return res.status(400).json({
          success: false,
          message: "Validation failed",
          errors,
        });
      }
      next(error);
    }
  };
};

module.exports = {
  signInSchema,
  signUpSchema,
  refreshTokenSchema,
  validate,
};
```

### 8.3 Password Security

```javascript
// src/modules/auth/services/password.service.js
const bcrypt = require("bcrypt");
const crypto = require("crypto");

class PasswordService {
  constructor() {
    this.SALT_ROUNDS = 12;
  }

  async hash(password) {
    return bcrypt.hash(password, this.SALT_ROUNDS);
  }

  async compare(password, hash) {
    return bcrypt.compare(password, hash);
  }

  generateSecureToken(length = 32) {
    return crypto.randomBytes(length).toString("hex");
  }

  generateOTP(length = 6) {
    return crypto
      .randomInt(Math.pow(10, length - 1), Math.pow(10, length))
      .toString();
  }
}

module.exports = new PasswordService();
```

---

## 9. Error Handling

### 9.1 Custom Error Classes

```javascript
// src/shared/utils/api-error.js
class ApiError extends Error {
  constructor(statusCode, message, code, errors) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.errors = errors;
    this.name = this.constructor.name;
    Error.captureStackTrace(this, this.constructor);
  }
}

class BadRequestError extends ApiError {
  constructor(message = "Bad request", errors) {
    super(400, message, "BAD_REQUEST", errors);
  }
}

class UnauthorizedError extends ApiError {
  constructor(message = "Unauthorized") {
    super(401, message, "UNAUTHORIZED");
  }
}

class ForbiddenError extends ApiError {
  constructor(message = "Forbidden") {
    super(403, message, "FORBIDDEN");
  }
}

class NotFoundError extends ApiError {
  constructor(message = "Resource not found") {
    super(404, message, "NOT_FOUND");
  }
}

class ConflictError extends ApiError {
  constructor(message = "Resource already exists") {
    super(409, message, "CONFLICT");
  }
}

class ValidationError extends ApiError {
  constructor(errors) {
    super(422, "Validation failed", "VALIDATION_ERROR", errors);
  }
}

class InternalServerError extends ApiError {
  constructor(message = "Internal server error") {
    super(500, message, "INTERNAL_SERVER_ERROR");
  }
}

module.exports = {
  ApiError,
  BadRequestError,
  UnauthorizedError,
  ForbiddenError,
  NotFoundError,
  ConflictError,
  ValidationError,
  InternalServerError,
};
```

### 9.2 Global Error Handler

```javascript
// src/shared/middlewares/error-handler.js
const { ApiError } = require("../utils/api-error");
const logger = require("../utils/logger");
const config = require("../../config");

function errorHandler(err, req, res, next) {
  let error = err;

  // Handle Mongoose errors
  if (err.name === "CastError") {
    error = new ApiError(
      400,
      `Invalid ${err.path}: ${err.value}`,
      "CAST_ERROR",
    );
  }

  if (err.code === 11000) {
    const field = Object.keys(err.keyValue)[0];
    error = new ApiError(409, `Duplicate field: ${field}`, "DUPLICATE_ENTRY");
  }

  if (err.name === "ValidationError") {
    const errors = Object.values(err.errors).map((e) => ({
      field: e.path,
      message: e.message,
    }));
    error = new ApiError(400, "Validation failed", "VALIDATION_ERROR", errors);
  }

  // Handle JWT errors
  if (err.name === "JsonWebTokenError") {
    error = new ApiError(401, "Invalid token", "INVALID_TOKEN");
  }

  if (err.name === "TokenExpiredError") {
    error = new ApiError(401, "Token expired", "TOKEN_EXPIRED");
  }

  // Log error
  logger.error({
    message: err.message,
    stack: err.stack,
    path: req.path,
    method: req.method,
    ip: req.ip,
    userId: req.user?._id,
  });

  // Send response
  if (error instanceof ApiError) {
    return res.status(error.statusCode).json({
      success: false,
      message: error.message,
      code: error.code,
      errors: error.errors,
      ...(config.isDevelopment && { stack: error.stack }),
    });
  }

  // Unknown error
  return res.status(500).json({
    success: false,
    message: "An unexpected error occurred",
    code: "INTERNAL_SERVER_ERROR",
    ...(config.isDevelopment && { stack: err.stack }),
  });
}

module.exports = { errorHandler };
```

### 9.3 Async Handler Utility

```javascript
// src/shared/utils/async-handler.js
const asyncHandler = (fn) => {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

module.exports = asyncHandler;
```

### 9.4 API Response Utility

```javascript
// src/shared/utils/api-response.js
class ApiResponse {
  static success(data, message = "Success") {
    return {
      success: true,
      message,
      data,
    };
  }

  static created(data, message = "Created successfully") {
    return {
      success: true,
      message,
      data,
    };
  }

  static paginated(data, pagination, message = "Success") {
    return {
      success: true,
      message,
      data,
      pagination,
    };
  }

  static error(message, code, errors = null) {
    return {
      success: false,
      message,
      code,
      errors,
    };
  }
}

module.exports = ApiResponse;
```

---

## 10. Logging & Monitoring

### 10.1 Winston Logger Setup

```javascript
// src/shared/utils/logger.js
const winston = require("winston");
const DailyRotateFile = require("winston-daily-rotate-file");
const config = require("../../config");

const logFormat = winston.format.combine(
  winston.format.timestamp({ format: "YYYY-MM-DD HH:mm:ss" }),
  winston.format.errors({ stack: true }),
  winston.format.json(),
);

const consoleFormat = winston.format.combine(
  winston.format.colorize(),
  winston.format.timestamp({ format: "HH:mm:ss" }),
  winston.format.printf(({ timestamp, level, message, ...meta }) => {
    return `${timestamp} [${level}]: ${message} ${
      Object.keys(meta).length ? JSON.stringify(meta, null, 2) : ""
    }`;
  }),
);

const transports = [
  new winston.transports.Console({
    format: consoleFormat,
    level: config.isDevelopment ? "debug" : "info",
  }),
];

if (!config.isDevelopment) {
  transports.push(
    new DailyRotateFile({
      filename: "logs/app-%DATE%.log",
      datePattern: "YYYY-MM-DD",
      maxSize: "20m",
      maxFiles: "14d",
      format: logFormat,
    }),
    new DailyRotateFile({
      filename: "logs/error-%DATE%.log",
      datePattern: "YYYY-MM-DD",
      maxSize: "20m",
      maxFiles: "14d",
      level: "error",
      format: logFormat,
    }),
  );
}

const logger = winston.createLogger({
  level: config.logLevel || "info",
  transports,
  exitOnError: false,
});

module.exports = logger;
```

### 10.2 Request Logging Middleware

```javascript
// src/shared/middlewares/request-logger.js
const { v4: uuidv4 } = require("uuid");
const logger = require("../utils/logger");

function requestLogger(req, res, next) {
  const requestId = uuidv4();
  const startTime = Date.now();

  // Attach request ID
  req.requestId = requestId;
  res.setHeader("X-Request-ID", requestId);

  // Log request
  logger.info({
    type: "REQUEST",
    requestId,
    method: req.method,
    path: req.path,
    query: req.query,
    ip: req.ip,
    userAgent: req.get("User-Agent"),
    userId: req.user?._id,
  });

  // Log response
  res.on("finish", () => {
    const duration = Date.now() - startTime;
    logger.info({
      type: "RESPONSE",
      requestId,
      method: req.method,
      path: req.path,
      statusCode: res.statusCode,
      duration: `${duration}ms`,
      userId: req.user?._id,
    });
  });

  next();
}

module.exports = { requestLogger };
```

---

## 11. Testing Strategy

### 11.1 Test Structure

```
tests/
├── unit/                           # Unit tests
│   ├── services/
│   │   ├── auth.service.test.js
│   │   ├── token.service.test.js
│   │   └── purchase.service.test.js
│   └── utils/
│       └── calculations.test.js
│
├── integration/                    # Integration tests
│   ├── auth/
│   │   ├── sign-in.test.js
│   │   ├── sign-up.test.js
│   │   └── refresh-token.test.js
│   ├── purchase/
│   │   └── paddy-purchase.test.js
│   └── setup.js                    # Test database setup
│
└── e2e/                           # End-to-end tests
    └── workflows/
        └── purchase-to-sale.test.js
```

### 11.2 Test Setup

```javascript
// tests/integration/setup.js
const mongoose = require("mongoose");
const { MongoMemoryServer } = require("mongodb-memory-server");

let mongoServer;

const setupTestDB = async () => {
  mongoServer = await MongoMemoryServer.create();
  const uri = mongoServer.getUri();
  await mongoose.connect(uri);
};

const teardownTestDB = async () => {
  await mongoose.connection.dropDatabase();
  await mongoose.connection.close();
  await mongoServer.stop();
};

module.exports = { setupTestDB, teardownTestDB };
```

### 11.3 Sample Test

```javascript
// tests/integration/auth/sign-in.test.js
const request = require("supertest");
const app = require("../../../src/app");
const User = require("../../../src/shared/models/user.model");
const { setupTestDB, teardownTestDB } = require("../setup");

describe("POST /api/v1/auth/sign-in", () => {
  beforeAll(async () => {
    await setupTestDB();
  });

  afterAll(async () => {
    await teardownTestDB();
  });

  beforeEach(async () => {
    await User.create({
      email: "test@example.com",
      password: "Test@123",
      name: "Test User",
      role: "MILL_ADMIN",
    });
  });

  afterEach(async () => {
    await User.deleteMany({});
  });

  it("should return tokens for valid credentials", async () => {
    const res = await request(app)
      .post("/api/v1/auth/sign-in")
      .send({ email: "test@example.com", password: "Test@123" });

    expect(res.status).toBe(200);
    expect(res.body.success).toBe(true);
    expect(res.body.data).toHaveProperty("accessToken");
    expect(res.body.data).toHaveProperty("refreshToken");
    expect(res.body.data.user.email).toBe("test@example.com");
  });

  it("should return 401 for invalid password", async () => {
    const res = await request(app)
      .post("/api/v1/auth/sign-in")
      .send({ email: "test@example.com", password: "wrongpassword" });

    expect(res.status).toBe(401);
    expect(res.body.success).toBe(false);
  });
});
```

---

## 12. Deployment & DevOps

### 12.1 Docker Configuration

```dockerfile
# Dockerfile
FROM node:22-alpine AS base
WORKDIR /app

# Dependencies stage
FROM base AS deps
COPY package.json package-lock.json ./
RUN npm ci --only=production

# Production stage
FROM base AS runner
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 expressjs

COPY --from=deps /app/node_modules ./node_modules
COPY . .

USER expressjs
EXPOSE 5000
CMD ["node", "src/server.js"]
```

```yaml
# docker-compose.yml
version: "3.8"

services:
  api:
    build: .
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/ricemill
    depends_on:
      - mongo
    restart: unless-stopped

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=ricemill

  mongo-express:
    image: mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
    depends_on:
      - mongo

volumes:
  mongo_data:
```

### 12.2 CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - run: npm ci
      - run: npm test
        env:
          MONGODB_URI: mongodb://localhost:27017/test
          ACCESS_TOKEN_SECRET: test-access-secret
          REFRESH_TOKEN_SECRET: test-refresh-secret

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t ricemill-api .

      - name: Push to registry
        run: |
          # Add your registry push commands here
          echo "Push to Docker Hub or ECR"
```

---

## 13. Implementation Phases

### Phase 1: Foundation (Week 1-2)

- [ ] Project setup & configuration
- [ ] MongoDB connection & models
- [ ] Authentication module (Passport.js)
- [ ] Access & Refresh token implementation
- [ ] User CRUD operations
- [ ] Basic error handling & logging

### Phase 2: Core Mill Features (Week 3-4)

- [ ] Mill management
- [ ] Staff management & attendance
- [ ] Master data (Party, Broker, Transporter, etc.)
- [ ] Socket.io integration
- [ ] Real-time dashboard

### Phase 3: Transaction Modules (Week 5-6)

- [ ] Purchase module (Paddy, Rice, Gunny, FRK, Other)
- [ ] Sales module (Rice, Paddy, Gunny, Khanda, Nakkhi, Other)
- [ ] Stock management & alerts
- [ ] Real-time transaction events

### Phase 4: Operations (Week 7-8)

- [ ] Inward module (Govt/Private Paddy, Rice, Gunny, etc.)
- [ ] Outward module (All types)
- [ ] Milling module (Paddy & Rice)
- [ ] Labour cost tracking

### Phase 5: Financial & Reports (Week 9-10)

- [ ] Financial receipts & payments
- [ ] Balance lifting reports
- [ ] Daily reports
- [ ] Broker & Party transaction reports
- [ ] Export functionality (PDF, Excel)

### Phase 6: Super Admin & Polish (Week 11-12)

- [ ] Super admin dashboard
- [ ] Subscription management
- [ ] Platform analytics
- [ ] Testing & bug fixes
- [ ] Performance optimization
- [ ] Security audit
- [ ] Documentation

---

## Environment Variables Reference

```env
# Server
NODE_ENV=development
PORT=5000
API_VERSION=v1

# MongoDB
MONGODB_URI=mongodb://localhost:27017/ricemill

# JWT Secrets (MUST BE DIFFERENT)
ACCESS_TOKEN_SECRET=your-super-secret-access-token-key-min-32-characters
ACCESS_TOKEN_EXPIRES_IN=15m
REFRESH_TOKEN_SECRET=your-different-secret-refresh-token-key-min-32-characters
REFRESH_TOKEN_EXPIRES_IN=7d

# OTP
OTP_SECRET=your-otp-secret
OTP_EXPIRES_IN=10m

# CORS
CLIENT_URL=http://localhost:5173

# OAuth (Optional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GOOGLE_CALLBACK_URL=http://localhost:5000/api/v1/auth/google/callback

GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=
GITHUB_CALLBACK_URL=http://localhost:5000/api/v1/auth/github/callback

# Email (Optional)
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASS=

# Logging
LOG_LEVEL=debug
```

---

## Quick Start Commands

```bash
# Install dependencies
npm install

# Start development server with nodemon
npm run dev

# Run tests
npm test

# Run tests with coverage
npm run test:coverage

# Lint code
npm run lint

# Format code
npm run format

# Build for production (if using bundler)
npm run build

# Start production server
npm start

# Docker development
docker-compose up -d

# Docker production build
docker build -t ricemill-api .

# Seed database
npm run seed
```

---

## Package.json Dependencies

```json
{
  "name": "ricemill-api",
  "version": "1.0.0",
  "description": "Rice Mill SaaS Platform Backend",
  "main": "src/server.js",
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/",
    "format": "prettier --write src/",
    "seed": "node scripts/seed.js"
  },
  "dependencies": {
    "bcrypt": "^5.1.1",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.0",
    "express-mongo-sanitize": "^2.2.0",
    "express-rate-limit": "^7.4.0",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^8.6.0",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "passport-local": "^1.0.0",
    "socket.io": "^4.7.5",
    "uuid": "^10.0.0",
    "winston": "^3.14.2",
    "winston-daily-rotate-file": "^5.0.0",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "eslint": "^9.10.0",
    "jest": "^29.7.0",
    "mongodb-memory-server": "^10.0.0",
    "nodemon": "^3.1.4",
    "prettier": "^3.3.3",
    "supertest": "^7.0.0"
  }
}
```

---

**This implementation plan provides a comprehensive, modular, scalable, and industry-standard backend architecture for the Rice Mill SaaS platform using JavaScript, MongoDB, and modern best practices.**
